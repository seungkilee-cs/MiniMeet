<!doctype html>
<html>
  <head>
    <title>2.3. Authenticated Room Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .controls {
        background: #f0f0f0;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .status {
        background: #e8f5e8;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .error {
        background: #ffeaea;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .participants {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      input,
      button {
        margin: 5px;
        padding: 8px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê MiniMeet Authenticated Room Test</h1>

      <div class="controls">
        <h3>1. Get Authentication Token</h3>
        <input id="userId" type="text" placeholder="Enter User ID" />
        <button onclick="getToken()">Get Token</button>
        <div
          id="tokenDisplay"
          style="
            margin-top: 10px;
            font-family: monospace;
            word-break: break-all;
          "
        ></div>
      </div>

      <div class="controls">
        <h3>2. Connect with Token</h3>
        <button onclick="connect()">Connect to Server</button>
        <button onclick="disconnect()">Disconnect</button>
      </div>

      <div class="controls">
        <h3>3. Room Operations</h3>
        <input id="roomId" type="text" placeholder="Enter Room ID" />
        <button onclick="joinRoom()">Join Room</button>
        <button onclick="leaveRoom()">Leave Room</button>
      </div>

      <div id="status" class="status">Not connected</div>
      <div id="error" class="error" style="display: none"></div>

      <div class="participants">
        <h3>Room Participants:</h3>
        <div id="participants">No participants</div>
      </div>

      <div class="participants">
        <h3>Console Logs:</h3>
        <div
          id="logs"
          style="
            height: 300px;
            overflow-y: scroll;
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
          "
        ></div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      let socket;
      let authToken = '';

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.getElementById('logs');
        logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => (errorDiv.style.display = 'none'), 5000);
      }

      function updateStatus(message) {
        document.getElementById('status').textContent = message;
      }

      async function getToken() {
        const userId = document.getElementById('userId').value.trim();
        if (!userId) {
          showError('Please enter a User ID');
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:3001/auth/token/${userId}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
            },
          );

          if (!response.ok) {
            throw new Error(`Failed to get token: ${response.statusText}`);
          }

          const data = await response.json();
          authToken = data.access_token;

          document.getElementById('tokenDisplay').innerHTML =
            `<strong>Token:</strong> ${authToken.substring(0, 50)}...`;

          log(`‚úÖ Token obtained for user ${userId}`);
        } catch (error) {
          log(`‚ùå Token error: ${error.message}`);
          showError(error.message);
        }
      }

      function connect() {
        if (!authToken) {
          showError('Please get a token first');
          return;
        }

        if (socket) socket.disconnect();

        // Pass token in auth object during connection
        socket = io('http://localhost:3001', {
          auth: {
            token: authToken,
          },
        });

        socket.on('connect', () => {
          log(`‚úÖ Connected! Socket ID: ${socket.id}`);
          updateStatus(`Connected and authenticated`);
        });

        socket.on('connectionSuccess', (data) => {
          log(`üéâ ${data.message}`);
          log(
            `üë§ Authenticated as: ${data.user.username} (${data.user.email})`,
          );
        });

        socket.on('disconnect', () => {
          log('‚ùå Disconnected from server');
          updateStatus('Disconnected');
        });

        socket.on('connect_error', (error) => {
          log(`‚ùå Connection error: ${error.message}`);
          showError(`Connection failed: ${error.message}`);
        });

        socket.on('authError', (data) => {
          log(`üîí Auth error: ${data.message}`);
          showError(`Authentication failed: ${data.message}`);
        });

        // Room event listeners
        socket.on('joinRoomSuccess', (data) => {
          log(`‚úÖ Successfully joined room: ${data.roomId}`);
        });

        socket.on('joinRoomError', (data) => {
          log(`‚ùå Failed to join room: ${data.error}`);
          showError(data.error);
        });

        socket.on('leaveRoomSuccess', (data) => {
          log(`‚úÖ Successfully left room: ${data.roomId}`);
          // Optional: Clear participant list immediately for leaving user
          document.getElementById('participants').innerHTML =
            '<em>You have left the room</em>';
        });

        socket.on('leaveRoomError', (data) => {
          log(`‚ùå Failed to leave room: ${data.error}`);
          showError(data.error);
        });
        socket.on('participantsUpdate', (data) => {
          log(
            `üë• Participants update for room ${data.roomId}: ${data.participants.length} users`,
          );
          displayParticipants(data.participants);

          // Clear UI if no participants (handles empty room case)
          if (data.participants.length === 0) {
            log(`üì≠ Room ${data.roomId} is now empty`);
          }
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }

      function joinRoom() {
        if (!socket || !socket.connected) {
          showError('Please connect first');
          return;
        }

        const roomId = document.getElementById('roomId').value.trim();
        if (!roomId) {
          showError('Please enter a Room ID');
          return;
        }

        log(`üì§ Sending joinRoom event: roomId=${roomId}`);
        socket.emit('joinRoom', { roomId });
      }

      function leaveRoom() {
        if (!socket || !socket.connected) {
          showError('Please connect first');
          return;
        }

        const roomId = document.getElementById('roomId').value.trim();
        if (!roomId) {
          showError('Please enter a Room ID');
          return;
        }

        log(`üì§ Sending leaveRoom event: roomId=${roomId}`);
        socket.emit('leaveRoom', { roomId });
      }

      function displayParticipants(participants) {
        const participantsDiv = document.getElementById('participants');

        if (!participants || participants.length === 0) {
          participantsDiv.innerHTML = '<em>No participants in room</em>';
          return;
        }

        const participantsList = participants
          .map(
            (p) =>
              `<div style="padding: 5px; border-bottom: 1px solid #ddd;">
      üë§ <strong>${p.username}</strong> (${p.email})<br>
      <small>ID: ${p.id}</small>
    </div>`,
          )
          .join('');

        participantsDiv.innerHTML = participantsList;
      }
    </script>
  </body>
</html>
